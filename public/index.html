<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Messenger Pro Max</title>
    <style>
        :root {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1c1e21;
            --border: #dddfe2;
            --msg-in: #f1f0f0;
            --msg-out: #dcf8c6;
            --primary: #1877f2;
            --sidebar-w: 260px;
        }

        [data-theme="dark"] {
            --bg: #18191a;
            --card-bg: #242526;
            --text: #e4e6eb;
            --border: #3a3b3c;
            --msg-in: #3a3b3c;
            --msg-out: #056162;
            --primary: #2d88ff;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; margin: 0; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        
        /* –≠–∫—Ä–∞–Ω—ã –≤—Ö–æ–¥–∞ */
        .auth-card { background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        #auth-screen, #login-screen { display: none; }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #app-screen { display: none; width: 90%; max-width: 900px; height: 80vh; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; }
        
        .sidebar { width: var(--sidebar-w); border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--card-bg); }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        /* –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç */
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .rooms-list { flex: 1; overflow-y: auto; }
        .room-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .room-item:hover { background: var(--msg-in); }
        .room-item.active { background: var(--primary); color: white; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column-reverse; }
        .msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 10px; max-width: 70%; position: relative; line-height: 1.4; }
        .msg.in { align-self: flex-start; background: var(--msg-in); }
        .msg.out { align-self: flex-end; background: var(--msg-out); }
        .msg-author { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; background: var(--card-bg); color: var(--text); }
        button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .theme-btn { cursor: pointer; font-size: 20px; position: fixed; top: 20px; right: 20px; z-index: 1000; background: var(--card-bg); padding: 10px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="theme-btn" onclick="toggleTheme()">üé®</div>

    <div id="auth-screen" class="auth-card">
        <h2>–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
        <input type="text" id="reg-user" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="email" id="reg-email" placeholder="–ü–æ—á—Ç–∞">
        <input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="doRegister()" style="width:100%">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <p onclick="showLogin()" style="cursor:pointer; color:var(--primary)">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</p>
    </div>

    <div id="login-screen" class="auth-card">
        <h2>–í—Ö–æ–¥</h2>
        <input type="email" id="login-email" placeholder="–ü–æ—á—Ç–∞">
        <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="doLogin()" style="width:100%">–í–æ–π—Ç–∏</button>
        <p onclick="showAuth()" style="cursor:pointer; color:var(--primary)">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
    </div>

    <div id="app-screen">
        <div class="sidebar">
            <div class="sidebar-header">
                –ß–∞—Ç—ã
                <button onclick="createNewGroup()" style="padding: 5px 10px; font-size: 12px;">+ –ì—Ä—É–ø–ø–∞</button>
            </div>
            <div id="rooms-list" class="rooms-list"></div>
            <div style="padding: 10px; border-top: 1px solid var(--border)">
                <button onclick="logout()" style="width:100%; background:#ff4d4d">–í—ã–π—Ç–∏</button>
            </div>
        </div>
        <div class="chat-area">
            <div class="sidebar-header">
                <span id="active-room-title">–û–±—â–∏–π —á–∞—Ç</span>
                <span id="my-name-tag" style="opacity: 0.6; font-size: 12px;"></span>
            </div>
            <div id="chat"></div>
            <div style="padding: 15px; background: var(--card-bg); display: flex; gap: 10px; border-top: 1px solid var(--border);">
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
                <button onclick="sendMsg()" style="width: 60px;">></button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = "";
        let currentRoom = "general";

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = () => {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);

            const user = localStorage.getItem('chat_session_user');
            if (user) {
                startApp(user);
            } else {
                showAuth();
            }
        };

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
        }

        function showLogin() { document.getElementById('auth-screen').style.display='none'; document.getElementById('login-screen').style.display='block'; }
        function showAuth() { document.getElementById('auth-screen').style.display='block'; document.getElementById('login-screen').style.display='none'; }

        function doRegister() {
            const u = document.getElementById('reg-user').value;
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            if(!u || !e || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!");
            localStorage.setItem('acc_'+e, JSON.stringify({u, p}));
            localStorage.setItem('chat_session_user', u);
            startApp(u);
        }

        function doLogin() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            const acc = JSON.parse(localStorage.getItem('acc_'+e) || '{}');
            if(acc.p === p) {
                localStorage.setItem('chat_session_user', acc.u);
                startApp(acc.u);
            } else alert("–ù–µ–≤–µ—Ä–Ω–æ!");
        }

        function logout() { localStorage.removeItem('chat_session_user'); location.reload(); }

        function startApp(user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-screen').style.display='flex';
            document.getElementById('my-name-tag').innerText = user;
            
            loadData();
            setInterval(loadData, 3000);
        }

        function createNewGroup() {
            const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã:");
            if(name) switchRoom(name.trim());
        }

        function switchRoom(name) {
            currentRoom = name;
            document.getElementById('active-room-title').innerText = name;
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/index?room=${currentRoom}`);
                const data = await res.json();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
                if(data.rooms && data.rooms.result) {
                    const list = document.getElementById('rooms-list');
                    list.innerHTML = data.rooms.result.map(r => `
                        <div class="room-item ${r === currentRoom ? 'active' : ''}" onclick="switchRoom('${r}')"># ${r}</div>
                    `).join('');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                if(data.messages && data.messages.result) {
                    document.getElementById('chat').innerHTML = data.messages.result.map(item => {
                        try {
                            const m = JSON.parse(decodeURIComponent(item));
                            const isMine = m.username === currentUser;
                            return `
                                <div class="msg ${isMine ? 'out' : 'in'}">
                                    <span class="msg-author">${isMine ? '–í—ã' : m.username}</span>
                                    ${m.text}
                                </div>
                            `;
                        } catch(e) { return `<div class="msg in">${decodeURIComponent(item)}</div>`; }
                    }).join('');
                }
            } catch(e) {}
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value) return;
            const msg = JSON.stringify({ username: currentUser, text: input.value });
            await fetch(`/api/index?room=${currentRoom}`, { method: 'POST', body: msg });
            input.value = '';
            loadData();
        }
    </script>
</body>
</html>
