<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeLink Ultra Enterprise Edition | Secure Communication & Collaboration Platform</title>
    
    <style>
        /* --- SYSTEM DESIGN TOKENS --- */
        :root {
            --ge-primary: #0084ff;
            --ge-primary-dark: #0063c2;
            --ge-primary-soft: rgba(0, 132, 255, 0.1);
            --ge-primary-glow: rgba(0, 132, 255, 0.4);
            
            --ge-success: #42b72a;
            --ge-danger: #fa3e3e;
            --ge-warning: #f7b928;
            --ge-info: #1877f2;
            
            /* Light Mode Variables */
            --ge-bg-page: #f0f2f5;
            --ge-bg-sidebar: #ffffff;
            --ge-bg-header: #ffffff;
            --ge-bg-card: #ffffff;
            --ge-bg-input: #f0f2f5;
            --ge-bg-bubble-in: #e4e6eb;
            --ge-bg-bubble-out: #0084ff;
            
            --ge-text-main: #1c1e21;
            --ge-text-muted: #65676b;
            --ge-text-white: #ffffff;
            
            --ge-border-color: #dddfe2;
            --ge-border-light: rgba(0,0,0,0.05);
            
            --ge-shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --ge-shadow-md: 0 12px 28px rgba(0,0,0,0.1);
            --ge-shadow-lg: 0 24px 50px rgba(0,0,0,0.15);
            
            /* Layout Constants */
            --sidebar-width: 440px;
            --header-height: 90px;
            --input-area-height: 100px;
            --transition-speed: 0.3s;
            --radius-main: 18px;
            --radius-pill: 50px;
        }

        /* --- DARK MODE OVERRIDES --- */
        [data-theme="dark"] {
            --ge-bg-page: #18191a;
            --ge-bg-sidebar: #242526;
            --ge-bg-header: #242526;
            --ge-bg-card: #242526;
            --ge-bg-input: #3a3b3c;
            --ge-bg-bubble-in: #3a3b3c;
            
            --ge-text-main: #e4e6eb;
            --ge-text-muted: #b0b3b8;
            
            --ge-border-color: #3e4042;
            --ge-shadow-md: 0 12px 28px rgba(0,0,0,0.5);
        }

        /* --- GLOBAL NORMALIZE --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body, html {
            height: 100%;
            width: 100%;
            background-color: var(--ge-bg-page);
            color: var(--ge-text-main);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- SCROLLBAR CUSTOMIZATION --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: #bcc0c4; 
            border-radius: 10px; 
            border: 2px solid transparent; 
            background-clip: content-box; 
        }
        ::-webkit-scrollbar-thumb:hover { background: #8d949e; }

        /* --- FIXED THEME SWITCHER --- */
        .ge-theme-launcher {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 100000;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            background: var(--ge-bg-card);
            border: 2px solid var(--ge-primary);
            border-radius: var(--radius-pill);
            cursor: pointer;
            box-shadow: var(--ge-shadow-md);
            transition: var(--transition-speed);
            color: var(--ge-primary);
            font-weight: 800;
            font-size: 14px;
            text-transform: uppercase;
        }
        .ge-theme-launcher:hover {
            transform: translateY(-4px);
            background: var(--ge-primary);
            color: white;
            box-shadow: 0 10px 20px var(--ge-primary-glow);
        }

        /* --- AUTHENTICATION MODULE (THE GIANT) --- */
        .ge-auth-fullscreen {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: var(--ge-bg-page);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: 
                radial-gradient(at 0% 0%, var(--ge-primary-soft) 0, transparent 50%), 
                radial-gradient(at 100% 100%, var(--ge-primary-soft) 0, transparent 50%);
        }

        .ge-auth-box {
            background: var(--ge-bg-card);
            width: 100%;
            max-width: 500px;
            padding: 70px 50px;
            border-radius: 32px;
            box-shadow: var(--ge-shadow-lg);
            text-align: center;
            border: 1px solid var(--ge-border-color);
            animation: ge-slide-in 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes ge-slide-in {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .ge-brand-title {
            font-size: 72px;
            font-weight: 900;
            color: var(--ge-primary);
            letter-spacing: -4px;
            margin-bottom: 10px;
        }

        .ge-auth-subtitle {
            font-size: 18px;
            color: var(--ge-text-muted);
            margin-bottom: 50px;
        }

        .ge-field-container {
            margin-bottom: 25px;
            text-align: left;
        }

        .ge-label {
            display: block;
            font-size: 12px;
            font-weight: 800;
            color: var(--ge-text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            padding-left: 10px;
        }

        .ge-input {
            width: 100%;
            padding: 18px 25px;
            border: 2px solid var(--ge-border-color);
            border-radius: 16px;
            background: var(--ge-bg-input);
            color: var(--ge-text-main);
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition-speed);
        }

        .ge-input:focus {
            outline: none;
            border-color: var(--ge-primary);
            background: var(--ge-bg-card);
            box-shadow: 0 0 0 4px var(--ge-primary-soft);
        }

        .ge-btn-submit {
            width: 100%;
            padding: 20px;
            background: var(--ge-primary);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition-speed);
            margin-top: 15px;
            box-shadow: 0 8px 16px var(--ge-primary-glow);
        }

        .ge-btn-submit:hover {
            background: var(--ge-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 12px 24px var(--ge-primary-glow);
        }

        /* --- MAIN APPLICATION FRAME --- */
        .ge-app-root {
            display: none; /* Hidden until auth */
            width: 100vw;
            height: 100vh;
            flex-direction: row;
        }

        /* SIDEBAR ARCHITECTURE */
        .ge-sidebar {
            width: var(--sidebar-width);
            background: var(--ge-bg-sidebar);
            border-right: 1px solid var(--ge-border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .ge-sidebar-header {
            padding: 40px 30px;
            border-bottom: 1px solid var(--ge-border-color);
        }

        .ge-user-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .ge-user-av {
            width: 65px;
            height: 65px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--ge-primary), #00d2ff);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 900;
            box-shadow: var(--ge-shadow-sm);
        }

        .ge-nav-menu {
            display: flex;
            background: var(--ge-bg-page);
            padding: 6px;
            border-radius: 14px;
            margin-bottom: 25px;
        }

        .ge-nav-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            color: var(--ge-text-muted);
            transition: var(--transition-speed);
            border: none;
            background: transparent;
        }

        .ge-nav-btn.active {
            background: var(--ge-bg-sidebar);
            color: var(--ge-primary);
            box-shadow: var(--ge-shadow-sm);
        }

        .ge-quick-actions {
            display: flex;
            gap: 12px;
        }

        .ge-action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--ge-border-color);
            background: var(--ge-bg-page);
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition-speed);
            color: var(--ge-text-main);
        }

        .ge-action-btn:hover {
            border-color: var(--ge-primary);
            color: var(--ge-primary);
        }

        /* ITEM LISTS */
        .ge-scroll-viewport {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .ge-list-entry {
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: var(--transition-speed);
            border-left: 4px solid transparent;
        }

        .ge-list-entry:hover {
            background: var(--ge-bg-page);
        }

        .ge-list-entry.selected {
            background: var(--ge-primary-soft);
            border-left-color: var(--ge-primary);
        }

        .ge-entry-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .ge-entry-sub {
            font-size: 12px;
            color: var(--ge-text-muted);
        }

        /* CHAT WORKSPACE */
        .ge-chat-engine {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--ge-bg-page);
        }

        .ge-top-navbar {
            height: var(--header-height);
            background: var(--ge-bg-header);
            border-bottom: 1px solid var(--ge-border-color);
            padding: 0 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ge-msg-scroll {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            gap: 18px;
        }

        /* MESSAGE BUBBLES UI */
        .ge-bubble {
            max-width: 65%;
            padding: 16px 24px;
            border-radius: 22px;
            font-size: 15px;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            animation: ge-bubble-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes ge-bubble-pop {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .ge-bubble.in {
            align-self: flex-start;
            background: var(--ge-bg-card);
            color: var(--ge-text-main);
            border-bottom-left-radius: 4px;
        }

        .ge-bubble.out {
            align-self: flex-end;
            background: var(--ge-bg-bubble-out);
            color: var(--ge-text-white);
            border-bottom-right-radius: 4px;
        }

        .ge-bubble b {
            display: block;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 5px;
            opacity: 0.7;
            letter-spacing: 0.5px;
        }

        /* BOTTOM INPUT SYSTEM */
        .ge-input-area {
            height: var(--input-area-height);
            padding: 0 40px;
            background: var(--ge-bg-header);
            border-top: 1px solid var(--ge-border-color);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .ge-main-composer {
            flex: 1;
            padding: 16px 30px;
            border-radius: 30px;
            border: 2px solid var(--ge-border-color);
            background: var(--ge-bg-page);
            color: var(--ge-text-main);
            font-size: 16px;
            transition: var(--transition-speed);
        }

        .ge-main-composer:focus {
            outline: none;
            border-color: var(--ge-primary);
            background: var(--ge-bg-header);
        }

        .ge-send-puck {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            background: var(--ge-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: var(--transition-speed);
            box-shadow: 0 6px 12px var(--ge-primary-glow);
        }

        .ge-send-puck:hover {
            transform: scale(1.1) rotate(5deg);
            background: var(--ge-primary-dark);
        }

        .ge-sidebar-footer {
            padding: 25px 30px;
            background: var(--ge-bg-sidebar);
            border-top: 1px solid var(--ge-border-color);
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex !important; }
    </style>
</head>
<body>

    <button class="ge-theme-launcher" onclick="geToggleTheme()">üåì –ü–ï–†–ï–ö–õ–Æ–ß–ò–¢–¨ –í–ò–î</button>

    <div id="ge-auth-module" class="ge-auth-fullscreen">
        <div class="ge-auth-box">
            <div class="ge-brand-title">GeLink</div>
            <p class="ge-auth-subtitle">Enterprise Security Suite v5.0</p>
            
            <div class="ge-field-container">
                <label class="ge-label">–ü–æ–ª–Ω–æ–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                <input type="text" id="reg-name" class="ge-input" placeholder="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ù–∏–∫–æ–ª–∞–µ–≤">
            </div>

            <div class="ge-field-container">
                <label class="ge-label">–†–∞–±–æ—á–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                <input type="email" id="reg-email" class="ge-input" placeholder="mail@company.com">
            </div>

            <div class="ge-field-container">
                <label class="ge-label">–ó–∞—â–∏—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="reg-pass" class="ge-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button class="ge-btn-submit" onclick="geInitializeSession()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
            <div style="margin-top: 25px; font-size: 12px; color: var(--ge-text-muted); font-weight: 600;">
                –í–∞—à —Ç—Ä–∞—Ñ–∏–∫ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É AES-256
            </div>
        </div>
    </div>

    <div id="ge-app-core" class="ge-app-root">
        
        <aside class="ge-sidebar">
            <div class="ge-sidebar-header">
                <div class="ge-user-meta">
                    <div class="ge-user-av" id="ge-my-av">?</div>
                    <div>
                        <b id="ge-my-name-tag" style="font-size: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
                        <div style="font-size: 12px; color: var(--ge-success); font-weight: 800;">‚óè –°–¢–ê–¢–£–°: –ê–ö–¢–ò–í–ï–ù</div>
                    </div>
                </div>

                <div class="ge-nav-menu">
                    <button id="nav-c" class="ge-nav-btn active" onclick="geChangeTab('chats')">–î–ò–ê–õ–û–ì–ò</button>
                    <button id="nav-f" class="ge-nav-btn" onclick="geChangeTab('friends')">–ö–û–ù–¢–ê–ö–¢–´</button>
                </div>

                <div class="ge-quick-actions">
                    <button class="ge-action-btn" onclick="geAddContact()">+ –ö–û–ù–¢–ê–ö–¢</button>
                    <button class="ge-action-btn" style="background: var(--ge-primary-soft); border-color: transparent;" onclick="geNewGroup()">+ –ì–†–£–ü–ü–ê</button>
                </div>
            </div>

            <div id="ge-chats-list" class="ge-scroll-viewport"></div>
            <div id="ge-friends-list" class="ge-scroll-viewport hidden"></div>

            <div class="ge-sidebar-footer">
                <button class="ge-btn-submit" style="background: var(--ge-danger); font-size: 14px; margin: 0; padding: 14px;" onclick="geLogout()">–í–´–ô–¢–ò –ò–ó –°–ò–°–¢–ï–ú–´</button>
            </div>
        </aside>

        <main class="ge-chat-engine">
            <header class="ge-top-navbar">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="ge-user-av" id="ge-active-av" style="background: #444; width: 55px; height: 55px; font-size: 20px;">#</div>
                    <div>
                        <b id="ge-active-title" style="font-size: 24px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
                        <div id="ge-active-status" style="font-size: 13px; opacity: 0.6;">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–µ–º—É –¥–∞–Ω–Ω—ã—Ö...</div>
                    </div>
                </div>
                <button id="ge-invite-button" class="ge-action-btn" style="width: auto; padding: 12px 25px; background: var(--ge-primary); color: white; border: none; display: none;" onclick="geInviteMember()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –í –ß–ê–¢</button>
            </header>

            <div id="ge-messages-window" class="ge-msg-scroll">
                </div>

            <footer class="ge-input-area">
                <input type="text" id="ge-msg-input" class="ge-main-composer" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞—â–∏—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ GeLink...">
                <button class="ge-send-puck" onclick="geSendMessage()">‚û§</button>
            </footer>
        </main>
    </div>

    <script>
        /**
         * –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
         */
        let userIdentity = { name: "", email: "" };
        let activeRoomId = "general";
        let currentActiveTab = "chats";

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏
         */
        function geInitializeSession() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();

            if (!name || !email || !pass) {
                return alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –í—Å–µ –ø–æ–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
            }

            if (pass.length < 6) {
                return alert("–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤).");
            }

            // –ò–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            userIdentity = { name, email };
            localStorage.setItem('ge_secure_vault', JSON.stringify(userIdentity));

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
            document.getElementById('ge-auth-module').classList.add('hidden');
            document.getElementById('ge-app-core').style.display = 'flex';
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI
            document.getElementById('ge-my-name-tag').innerText = name;
            document.getElementById('ge-my-av').innerText = name[0].toUpperCase();

            // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            geStartSyncLoop();
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
         */
        function geToggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', target);
        }

        /**
         * –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
         */
        function geChangeTab(tab) {
            currentActiveTab = tab;
            document.getElementById('nav-c').classList.toggle('active', tab === 'chats');
            document.getElementById('nav-f').classList.toggle('active', tab === 'friends');
            
            document.getElementById('ge-chats-list').classList.toggle('hidden', tab !== 'chats');
            document.getElementById('ge-friends-list').classList.toggle('hidden', tab !== 'friends');
        }

        /**
         * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å "—Å–µ—Ä–≤–µ—Ä–æ–º"
         */
        async function geSyncData() {
            if (!userIdentity.email) return;

            try {
                const url = `/api/index?room=${activeRoomId}&user_email=${userIdentity.email}`;
                const response = await fetch(url);
                const data = await response.json();

                // –†–µ–Ω–¥–µ—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
                const chatList = document.getElementById('ge-chats-list');
                if (data.rooms?.result) {
                    chatList.innerHTML = data.rooms.result.map(room => `
                        <div class="ge-list-entry ${room === activeRoomId ? 'selected' : ''}" onclick="geJoinRoom('${room}')">
                            <div class="ge-user-av" style="background:#555; width:45px; height:45px; font-size:18px;">${room[0].toUpperCase()}</div>
                            <div>
                                <div class="ge-entry-title">${room}</div>
                                <div class="ge-entry-sub">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –∫–∞–Ω–∞–ª</div>
                            </div>
                        </div>
                    `).join('');
                }

                // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                const friendList = document.getElementById('ge-friends-list');
                if (data.contacts?.result) {
                    friendList.innerHTML = data.contacts.result.map(email => `
                        <div class="ge-list-entry" onclick="geOpenPrivateChat('${email}')">
                            <div class="ge-user-av" style="width:45px; height:45px; font-size:18px;">${email[0].toUpperCase()}</div>
                            <div>
                                <div class="ge-entry-title">${email}</div>
                                <div class="ge-entry-sub">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ GeLink</div>
                            </div>
                        </div>
                    `).join('');
                }

                // –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ–∫–Ω–µ
                const msgWindow = document.getElementById('ge-messages-window');
                if (data.messages?.result) {
                    msgWindow.innerHTML = data.messages.result.map(encoded => {
                        const m = JSON.parse(decodeURIComponent(encoded));
                        const isMe = m.email === userIdentity.email;
                        return `
                            <div class="ge-bubble ${isMe ? 'out' : 'in'}">
                                <b>${isMe ? '–í—ã' : m.username}</b>
                                ${m.text}
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.warn("Sync warning: API endpoint might be offline.");
            }
        }

        /**
         * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
         */
        async function geSendMessage() {
            const input = document.getElementById('ge-msg-input');
            const text = input.value.trim();
            if (!text) return;

            const payload = JSON.stringify({ 
                username: userIdentity.name, 
                email: userIdentity.email, 
                text: text 
            });

            input.value = ''; // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

            try {
                await fetch(`/api/index?room=${activeRoomId}&user_email=${userIdentity.email}`, {
                    method: 'POST',
                    body: payload
                });
                geSyncData();
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.");
            }
        }

        /**
         * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏
         */
        function geJoinRoom(id, label = null) {
            activeRoomId = id;
            document.getElementById('ge-active-title').innerText = label || id;
            document.getElementById('ge-active-av').innerText = (label || id)[0].toUpperCase();
            
            const isGroup = !id.includes('private-') && id !== 'general';
            document.getElementById('ge-invite-button').style.display = isGroup ? 'block' : 'none';
            
            geSyncData();
        }

        function geOpenPrivateChat(email) {
            const pair = [userIdentity.email, email].sort();
            const roomId = `private-${pair[0].replace(/[@.]/g, '')}-${pair[1].replace(/[@.]/g, '')}`;
            geJoinRoom(roomId, email);
            geChangeTab('chats');
        }

        /**
         * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
         */
        async function geAddContact() {
            const email = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π Email –∫–æ–ª–ª–µ–≥–∏:");
            if (email && email !== userIdentity.email) {
                await fetch(`/api/index?action=addContact&user_email=${userIdentity.email}&target_email=${email}`);
                geSyncData();
            }
        }

        function geNewGroup() {
            const gName = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞–±–æ—á–µ–π –≥—Ä—É–ø–ø—ã:");
            if (gName) geJoinRoom(gName.trim());
        }

        function geStartSyncLoop() {
            geSyncData();
            setInterval(geSyncData, 4000);
        }

        function geLogout() {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–∞–Ω—Å? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.")) {
                localStorage.clear();
                location.reload();
            }
        }

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏
        window.onload = () => {
            const saved = localStorage.getItem('ge_secure_vault');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('reg-name').value = data.name;
                document.getElementById('reg-email').value = data.email;
                document.getElementById('reg-pass').value = '******';
                geInitializeSession();
            }
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
        document.getElementById('ge-msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') geSendMessage();
        });

        /* --- END OF SCRIPT --- */
    </script>
</body>
</html>
