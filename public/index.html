<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Messenger Ultra Professional Edition</title>
    <style>
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–°–í–ï–†–•–ü–û–õ–ù–´–ô –ù–ê–ë–û–†) --- */
        :root {
            --bg-body: #f0f2f5;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f0f2f5;
            --text-main: #1c1e21;
            --text-muted: #65676b;
            --text-on-primary: #ffffff;
            --border: #dddfe2;
            --primary: #1877f2;
            --primary-hover: #166fe5;
            --secondary: #e4e6eb;
            --success: #42b72a;
            --danger: #fa3e3e;
            --msg-in: #ffffff;
            --msg-out: #e7f3ff;
            --msg-text-out: #0541b0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.15);
            --shadow-lg: 0 12px 28px rgba(0,0,0,0.2);
            --radius-lg: 16px;
            --radius-md: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #18191a;
            --bg-sidebar: #242526;
            --bg-card: #242526;
            --bg-input: #3a3b3c;
            --text-main: #e4e6eb;
            --text-muted: #b0b3b8;
            --border: #3e4042;
            --primary: #2d88ff;
            --msg-in: #3a3b3c;
            --msg-out: #263951;
            --msg-text-out: #d1e7ff;
            --shadow-lg: 0 12px 28px rgba(0,0,0,0.5);
        }

        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò --- */
        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: var(--transition);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- –≠–ö–†–ê–ù–´ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò --- */
        .auth-container {
            position: fixed;
            inset: 0;
            background: var(--bg-body);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .auth-box {
            background: var(--bg-card);
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            text-align: center;
            animation: fadeInScale 0.4s ease;
        }

        .auth-box h1 { font-size: 32px; color: var(--primary); margin: 0 0 10px; }
        .auth-box p { color: var(--text-muted); margin-bottom: 30px; }

        input {
            width: 100%;
            padding: 14px 18px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-input);
            color: var(--text-main);
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.2); }

        button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        /* --- –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø --- */
        .app-layout {
            display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ –ª–æ–≥–∏–Ω–∞ */
            width: 100vw;
            height: 100vh;
            background: var(--bg-body);
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 380px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 20px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
        }

        .user-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px;
            box-shadow: var(--shadow-sm);
        }

        /* –¢–∞–±—ã */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tab-item {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab-item.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* –°–ø–∏—Å–∫–∏ */
        .scroll-list {
            flex: 1;
            overflow-y: auto;
        }

        .list-entry {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }

        .list-entry:hover { background: var(--bg-body); }
        .list-entry.active { background: var(--msg-out); border-left: 4px solid var(--primary); }

        .entry-details b { display: block; font-size: 16px; margin-bottom: 2px; }
        .entry-details span { font-size: 13px; color: var(--text-muted); }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –ß–∞—Ç */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-body);
        }

        .chat-header {
            height: 70px;
            padding: 0 25px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* –°–æ–æ–±—â–µ–Ω–∏—è —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö */
            gap: 15px;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è (–ü—É–∑—ã—Ä–∏) */
        .msg {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            animation: fadeInScale 0.2s ease-out;
        }

        .msg.incoming {
            align-self: flex-start;
            background: var(--msg-in);
            border-bottom-left-radius: 4px;
        }

        .msg.outgoing {
            align-self: flex-end;
            background: var(--msg-out);
            color: var(--msg-text-out);
            border-bottom-right-radius: 4px;
        }

        .msg small {
            display: block;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .chat-input-bar {
            padding: 20px 25px;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
        }

        .chat-input-bar input { margin: 0; border-radius: 25px; }

        .btn-round {
            width: 50px; height: 50px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: var(--primary);
            color: white; border: none; cursor: pointer;
            font-size: 20px; flex-shrink: 0;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º (–ü–ª–∞–≤–∞—é—â–∏–π) */
        .theme-fab {
            position: fixed; top: 20px; right: 20px;
            width: 45px; height: 45px;
            background: var(--bg-sidebar);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--shadow-md);
            z-index: 10001; font-size: 20px;
        }

        .dropdown {
            display: none;
            position: absolute; top: 55px; right: 0;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            width: 150px; padding: 5px;
        }

        .dropdown div {
            padding: 10px; border-radius: 5px; cursor: pointer;
        }

        .dropdown div:hover { background: var(--bg-body); }
    </style>
</head>
<body>

    <div class="theme-fab" onclick="toggleThemeMenu()">
        üé®
        <div id="theme-dropdown" class="dropdown">
            <div onclick="setTheme('light')">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</div>
            <div onclick="setTheme('dark')">üåô –¢–µ–º–Ω–∞—è</div>
        </div>
    </div>

    <div id="auth-screen" class="auth-container">
        <div class="auth-box">
            <h1>Cloud Messenger</h1>
            <p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
            <input type="text" id="username-in" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è...">
            <button onclick="handleLogin()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>
    </div>

    <div id="app-layout" class="app-layout" style="display: flex;">
        
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-bar">
                    <div class="avatar" id="my-avatar">?</div>
                    <div>
                        <b id="my-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>
                        <div style="font-size: 12px; color: var(--success);">–í —Å–µ—Ç–∏</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div id="tab-chats" class="tab-item active" onclick="switchTab('chats')">–ß–ê–¢–´</div>
                    <div id="tab-contacts" class="tab-item" onclick="switchTab('contacts')">–ö–û–ù–¢–ê–ö–¢–´</div>
                </div>

                <div style="display: flex; gap: 5px;">
                    <button onclick="addFriend()" style="padding: 8px; font-size: 12px;">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
                    <button onclick="createGroup()" style="padding: 8px; font-size: 12px; background: var(--success);">+ –ì—Ä—É–ø–ø–∞</button>
                </div>
            </div>

            <div id="list-chats" class="scroll-list"></div>
            <div id="list-contacts" class="scroll-list" style="display:none"></div>

            <div style="padding: 15px; border-top: 1px solid var(--border);">
                <button onclick="logout()" style="background: var(--danger);">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="avatar" id="chat-icon">#</div>
                    <div>
                        <b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</b>
                        <div id="chat-status" style="font-size: 12px; opacity: 0.6;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞</div>
                    </div>
                </div>
                <button id="invite-btn" onclick="inviteToGroup()" style="display:none; width:auto; padding:8px 15px; font-size:12px;">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
            </div>

            <div id="chat-messages" class="chat-messages"></div>

            <div class="chat-input-bar">
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn-round" onclick="send()">></button>
            </div>
        </div>
    </div>

    <script>
        let me = "";
        let currentRoom = "general";
        let currentTab = "chats";

        // –ó–ê–ì–†–£–ó–ö–ê
        window.onload = () => {
            const theme = localStorage.getItem('theme') || 'light';
            setTheme(theme);
            const user = localStorage.getItem('chat_user');
            if (user) {
                document.getElementById('username-in').value = user;
                handleLogin();
            }
        };

        // –¢–ï–ú–´
        function toggleThemeMenu() {
            const d = document.getElementById('theme-dropdown');
            d.style.display = (d.style.display === 'block') ? 'none' : 'block';
        }
        function setTheme(t) {
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
            document.getElementById('theme-dropdown').style.display = 'none';
        }

        // –õ–û–ì–ò–ö–ê –í–ö–õ–ê–î–û–ö
        function switchTab(t) {
            currentTab = t;
            document.getElementById('tab-chats').classList.toggle('active', t === 'chats');
            document.getElementById('tab-contacts').classList.toggle('active', t === 'contacts');
            document.getElementById('list-chats').style.display = (t === 'chats' ? 'block' : 'none');
            document.getElementById('list-contacts').style.display = (t === 'contacts' ? 'block' : 'none');
        }

        // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        function handleLogin() {
            const u = document.getElementById('username-in').value.trim();
            if (!u) return;
            me = u;
            localStorage.setItem('chat_user', u);
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-layout').style.display = 'flex';
            document.getElementById('my-name').innerText = u;
            document.getElementById('my-avatar').innerText = u[0].toUpperCase();
            
            refresh();
            setInterval(refresh, 3000);
        }

        function logout() { localStorage.removeItem('chat_user'); location.reload(); }

        // –ö–û–ù–¢–ê–ö–¢–´ –ò –ì–†–£–ü–ü–´
        async function addFriend() {
            const name = prompt("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:");
            if (name && name !== me) {
                await fetch(`/api/index?action=addContact&user=${me}&target=${name}`);
                alert("–î–æ–±–∞–≤–ª–µ–Ω–æ!");
                refresh();
            }
        }

        function createGroup() {
            const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã:");
            if (name) openRoom(name);
        }

        async function inviteToGroup() {
            const friend = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥—Ä—É–≥–∞ –∏–∑ –≤–∞—à–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:");
            if (!friend) return;
            const msg = JSON.stringify({ username: "SYSTEM", text: `${me} –ø—Ä–∏–≥–ª–∞—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${friend}` });
            await fetch(`/api/index?room=${currentRoom}&user=${friend}`, { method: 'POST', body: msg });
            alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω!");
        }

        function openRoom(id, label = null) {
            currentRoom = id;
            document.getElementById('chat-title').innerText = label || id;
            document.getElementById('chat-icon').innerText = (label || id)[0].toUpperCase();
            document.getElementById('chat-status').innerText = id.includes('private:') ? "–õ–∏—á–Ω—ã–π –¥–∏–∞–ª–æ–≥" : "–ì—Ä—É–ø–ø–∞";
            document.getElementById('invite-btn').style.display = (id.includes('private:') || id === 'general' ? 'none' : 'block');
            refresh();
        }

        function startPrivate(friend) {
            const pair = [me, friend].sort();
            const roomId = `private:${pair[0]}:${pair[1]}`;
            openRoom(roomId, friend);
            switchTab('chats');
        }

        // –û–ë–ú–ï–ù –î–ê–ù–ù–´–ú–ò
        async function refresh() {
            try {
                const res = await fetch(`/api/index?room=${currentRoom}&user=${me}`);
                const data = await res.json();

                // –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                const cBox = document.getElementById('list-chats');
                if (data.rooms?.result) {
                    cBox.innerHTML = data.rooms.result.map(r => `
                        <div class="list-entry ${r === currentRoom ? 'active' : ''}" onclick="openRoom('${r}')">
                            <div class="avatar" style="background:#888">${r[0].toUpperCase()}</div>
                            <div class="entry-details"><b>${r}</b><span>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</span></div>
                        </div>
                    `).join('');
                }

                // –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                const fBox = document.getElementById('list-contacts');
                if (data.contacts?.result) {
                    fBox.innerHTML = data.contacts.result.map(c => `
                        <div class="list-entry" onclick="startPrivate('${c}')">
                            <div class="avatar">${c[0].toUpperCase()}</div>
                            <div class="entry-details"><b>${c}</b><span>–ù–∞–ø–∏—Å–∞—Ç—å –ª–∏—á–Ω–æ</span></div>
                        </div>
                    `).join('');
                }

                // –°–æ–æ–±—â–µ–Ω–∏—è
                const mBox = document.getElementById('chat-messages');
                if (data.messages?.result) {
                    mBox.innerHTML = data.messages.result.map(item => {
                        const m = JSON.parse(decodeURIComponent(item));
                        const isMe = m.username === me;
                        return `
                            <div class="msg ${isMe ? 'outgoing' : 'incoming'}">
                                <small>${isMe ? '–í—ã' : m.username}</small>
                                ${m.text}
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {}
        }

        async function send() {
            const i = document.getElementById('msg-input');
            if (!i.value.trim()) return;
            const payload = JSON.stringify({ username: me, text: i.value });
            await fetch(`/api/index?room=${currentRoom}&user=${me}`, { method: 'POST', body: payload });
            i.value = '';
            refresh();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Ç–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –º–∏–º–æ
        window.onclick = (e) => {
            if (!e.target.matches('.theme-fab')) document.getElementById('theme-dropdown').style.display='none';
        }
    </script>
</body>
</html>
