<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Cloud Messenger Pro</title>
    <style>
        /* –ü–ï–†–ï–ú–ï–ù–ù–´–ï –¶–í–ï–¢–û–í –î–õ–Ø –¢–ï–ú */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1c1e21;
            --input-border: #dddfe2;
            --msg-bg: #f1f0f0;
            --primary-blue: #1877f2;
            --error-color: #fa3e3e;
        }

        [data-theme="dark"] {
            --bg-color: #18191a;
            --card-bg: #242526;
            --text-color: #e4e6eb;
            --input-border: #3a3b3c;
            --msg-bg: #3a3b3c;
            --primary-blue: #2d88ff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            transition: background 0.3s, color 0.3s; 
        }

        .card { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            width: 350px; 
            position: relative; 
        }

        /* –ö–Ω–æ–ø–∫–∞ –∏ –º–µ–Ω—é —Ç–µ–º */
        .theme-toggle-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            cursor: pointer; 
            font-size: 22px; 
            user-select: none;
        }

        .theme-dropdown { 
            display: none; 
            position: absolute; 
            top: 45px; 
            right: 10px; 
            background: var(--card-bg); 
            border: 1px solid var(--input-border); 
            border-radius: 8px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            z-index: 1000;
        }

        .theme-option { 
            padding: 10px 20px; 
            cursor: pointer; 
            white-space: nowrap; 
        }

        .theme-option:hover { background: var(--msg-bg); }

        /* –≠–∫—Ä–∞–Ω—ã */
        #auth-screen, #login-screen, #chat-screen { display: none; }

        h2 { text-align: center; margin-bottom: 20px; }
        
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: 1px solid var(--input-border); 
            border-radius: 6px; 
            box-sizing: border-box; 
            background: var(--card-bg); 
            color: var(--text-color);
        }

        button { 
            width: 100%; 
            padding: 12px; 
            background: var(--primary-blue); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px;
        }

        button:hover { opacity: 0.9; }

        .link-text { 
            text-align: center; 
            margin-top: 15px; 
            font-size: 14px; 
            color: var(--primary-blue); 
            cursor: pointer; 
        }

        .error { color: var(--error-color); font-size: 13px; text-align: center; margin-bottom: 10px; display: none; }

        /* –°—Ç–∏–ª–∏ —á–∞—Ç–∞ */
        #chat-screen { width: 450px; }
        #chat { 
            height: 400px; 
            border: 1px solid var(--input-border); 
            background: var(--card-bg); 
            overflow-y: auto; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            display: flex; 
            flex-direction: column-reverse; 
        }

        .msg-item { 
            margin-bottom: 10px; 
            padding: 10px; 
            border-radius: 8px; 
            background: var(--msg-bg); 
            word-wrap: break-word;
        }

        .msg-user { color: var(--primary-blue); font-weight: bold; margin-right: 5px; }

        .chat-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }

        .logout-btn { 
            width: auto; 
            background: #ff4d4d; 
            padding: 6px 12px; 
            font-size: 12px; 
            margin: 0;
        }
    </style>
</head>
<body>

    <div class="theme-toggle-btn" onclick="toggleThemeMenu()">üé®
        <div id="theme-menu" class="theme-dropdown">
            <div class="theme-option" onclick="setTheme('light')">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</div>
            <div class="theme-option" onclick="setTheme('dark')">üåô –¢–µ–º–Ω–∞—è</div>
        </div>
    </div>

    <div id="auth-screen" class="card">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <div id="reg-error" class="error"></div>
        <input type="text" id="reg-user" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="email" id="reg-email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞">
        <input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <input type="password" id="reg-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        <button onclick="handleRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <div class="link-text" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</div>
    </div>

    <div id="login-screen" class="card">
        <h2>–í—Ö–æ–¥</h2>
        <div id="login-error" class="error"></div>
        <input type="email" id="login-email" placeholder="–ü–æ—á—Ç–∞">
        <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        <div class="link-text" onclick="showRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
    </div>

    <div id="chat-screen" class="card">
        <div class="chat-header">
            <h3 id="user-display" style="margin: 0;"></h3>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div id="chat">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="sendMessage()" style="width: 60px; margin: 0;">></button>
        </div>
    </div>

    <script>
        let currentUser = "";

        // –ü–†–û–í–ï–†–ö–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        window.onload = function() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–º—É
            const savedTheme = localStorage.getItem('app_theme') || 'light';
            setTheme(savedTheme);

            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const sessionUser = localStorage.getItem('chat_session_user');
            if (sessionUser) {
                startChat(sessionUser);
            } else {
                document.getElementById('auth-screen').style.display = 'block';
            }
        };

        // –§–£–ù–ö–¶–ò–ò –¢–ï–ú–´
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('app_theme', theme);
            document.getElementById('theme-menu').style.display = 'none';
        }

        // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í
        function showLogin() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
        }

        function showRegister() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'block';
        }

        // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
        function handleRegister() {
            const user = document.getElementById('reg-user').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const confirm = document.getElementById('reg-confirm').value;
            const errorDiv = document.getElementById('reg-error');

            if (!user || !email || !pass) {
                errorDiv.innerText = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!";
                errorDiv.style.display = "block";
                return;
            }
            if (pass !== confirm) {
                errorDiv.innerText = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!";
                errorDiv.style.display = "block";
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º "–∞–∫–∫–∞—É–Ω—Ç"
            localStorage.setItem('account_' + email, JSON.stringify({ user, pass }));
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é
            localStorage.setItem('chat_session_user', user);
            startChat(user);
        }

        // –í–•–û–î
        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errorDiv = document.getElementById('login-error');

            const savedData = localStorage.getItem('account_' + email);
            if (savedData) {
                const account = JSON.parse(savedData);
                if (account.pass === pass) {
                    localStorage.setItem('chat_session_user', account.user);
                    startChat(account.user);
                    return;
                }
            }
            errorDiv.innerText = "–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å!";
            errorDiv.style.display = "block";
        }

        // –í–´–•–û–î
        function logout() {
            localStorage.removeItem('chat_session_user');
            location.reload();
        }

        // –ó–ê–ü–£–°–ö –ß–ê–¢–ê
        function startChat(user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'block';
            document.getElementById('user-display').innerText = "–í—ã: " + user;
            
            loadMessages();
            setInterval(loadMessages, 3000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
        }

        // –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô
        async function loadMessages() {
            try {
                const response = await fetch('/api/index');
                const data = await response.json();
                
                if (data.result) {
                    const chatDiv = document.getElementById('chat');
                    chatDiv.innerHTML = data.result.map(item => {
                        try {
                            const m = JSON.parse(decodeURIComponent(item));
                            return `<div class="msg-item"><span class="msg-user">${m.username}:</span> ${m.text}</div>`;
                        } catch(e) {
                            return `<div class="msg-item">${decodeURIComponent(item)}</div>`;
                        }
                    }).join('');
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
            }
        }

        // –û–¢–ü–†–ê–í–ö–ê
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const msgData = JSON.stringify({ username: currentUser, text: text });
            
            await fetch('/api/index', { 
                method: 'POST', 
                body: msgData 
            });

            input.value = '';
            loadMessages();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —Ç–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
        window.onclick = function(event) {
            if (!event.target.matches('.theme-toggle-btn')) {
                document.getElementById('theme-menu').style.display = 'none';
            }
        }
    </script>
</body>
</html>
