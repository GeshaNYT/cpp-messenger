<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Messenger Auth</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; }
        h2 { text-align: center; color: #1c1e21; margin-bottom: 20px; }
        #chat-screen { display: none; width: 450px; }
        #login-screen { display: none; } /* Скрыт по умолчанию */
        #chat { height: 400px; border: 1px solid #e4e6eb; background: #fff; overflow-y: auto; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dddfe2; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #1877f2; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background: #166fe5; }
        .link-text { text-align: center; margin-top: 15px; font-size: 14px; color: #1877f2; cursor: pointer; }
        .error { color: red; font-size: 13px; margin-bottom: 10px; display: none; text-align: center; }
    </style>
</head>
<body>

    <div id="auth-screen" class="card">
        <h2>Регистрация</h2>
        <div id="reg-error" class="error"></div>
        <input type="text" id="reg-user" placeholder="Имя пользователя">
        <input type="email" id="reg-email" placeholder="Электронная почта">
        <input type="password" id="reg-pass" placeholder="Пароль">
        <input type="password" id="reg-confirm" placeholder="Повторите пароль">
        <button onclick="handleRegister()">Зарегистрироваться</button>
        <div class="link-text" onclick="showLogin()">Уже есть аккаунт? Войти</div>
    </div>

    <div id="login-screen" class="card">
        <h2>Вход</h2>
        <div id="login-error" class="error">Неверные данные!</div>
        <input type="email" id="login-email" placeholder="Электронная почта">
        <input type="password" id="login-pass" placeholder="Пароль">
        <button onclick="handleLogin()">Войти</button>
        <div class="link-text" onclick="showRegister()">Нет аккаунта? Создать</div>
    </div>

    <div id="chat-screen" class="card">
        <h3 id="user-display"></h3>
        <div id="chat">Загрузка...</div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="m" placeholder="Сообщение...">
            <button onclick="send()" style="width: 60px;">></button>
        </div>
    </div>

    <script>
        let currentUser = "";

        // Переключение экранов
        function showLogin() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
        }

        function showRegister() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'block';
        }

        // Логика регистрации
        function handleRegister() {
            const user = document.getElementById('reg-user').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const confirm = document.getElementById('reg-confirm').value;
            const errEl = document.getElementById('reg-error');

            if (!user || !email || !pass) {
                errEl.innerText = "Заполните все поля!";
                errEl.style.display = "block";
                return;
            }
            if (pass !== confirm) {
                errEl.innerText = "Пароли не совпадают!";
                errEl.style.display = "block";
                return;
            }

            // Сохраняем "аккаунт" в память браузера (для простоты)
            localStorage.setItem(email, JSON.stringify({ user, pass }));
            
            enterChat(user);
        }

        // Логика входа
        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errEl = document.getElementById('login-error');

            const savedAccount = localStorage.getItem(email);
            if (savedAccount) {
                const account = JSON.parse(savedAccount);
                if (account.pass === pass) {
                    enterChat(account.user);
                    return;
                }
            }
            
            errEl.style.display = "block";
        }

        function enterChat(user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'block';
            document.getElementById('user-display').innerText = "Чат (Вы: " + user + ")";
            load();
            setInterval(load, 3000);
        }

        // Работа с сообщениями (API)
        async function load() {
            const res = await fetch('/api/index');
            const data = await res.json();
            if (data.result) {
                document.getElementById('chat').innerHTML = data.result
                    .map(msg => `<div><strong>${decodeURIComponent(msg)}</strong></div>`)
                    .join('');
            }
        }

        async function send() {
            const el = document.getElementById('m');
            if (!el.value) return;
            await fetch('/api/index', { 
                method: 'POST', 
                body: JSON.stringify({ username: currentUser, text: el.value }) 
            });
            el.value = '';
            load();
        }
    </script>
</body>
</html>
